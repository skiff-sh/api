syntax = "proto3";

package skiff.cmd.v1alpha1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";
import "skiff/registry/v1alpha1/registry.proto";

option go_package = "github.com/skiff-sh/api/go/skiff/cmd/v1alpha1";

// Generates all files within the package and returns the diffs that would result from them being written. Packages hold both templates and WASM plugins that are
// executed locally to edit local files.
message AddPackageRequest {
  // An absolute filepath to the project root. This is used as the root for all plugin file reads and the base reference path for all file outputs.
  string project_root = 1 [
    json_name = "project_root",
    (buf.validate.field).string.min_len = 1
  ];

  // The file path or http(s) URLs to the package. HTTP(s) URLs must start with "http(s)://", otherwise, it's treated as a filepath.
  string package = 2 [(buf.validate.field).string.min_len = 1];

  // The data needed by the package. Should be a simple map of the field name to the value.
  map<string, google.protobuf.Value> data = 3;
}

// The response data for AddPackageRequest.
message AddPackageResponse {
  // A list of file diffs that should be applied to the user's machine. These use the absolute path using the "project_root" field passed into the request.
  // There is a single unified diff per file.
  repeated string unified_diffs = 1 [json_name = "unified_diffs"];
}

// Get detailed information about a set of packages. Includes the contents of the files that the packages would add if add package was called.
message ViewPackagesRequest {
  // The URLs or local file paths to packages e.g. ./skiff/public/r/create-http-route.json
  repeated string packages = 1;
}

message ViewPackagesResponse {
  // Returns the entirety of the contents of the package. If the package contains a plugin file, the contents of the file are not returned as they are just WASM bytes.
  repeated skiff.registry.v1alpha1.Package packages = 1;
}

// List all packages within a set of registries. These packages do not include the contents of the files. To get more details about a package use the view package
// call.
message ListPackagesRequest {
  // The URLs or local file paths to registries e.g. ./.skiff/registry.json.
  repeated string registries = 1;

  // The absolute path to the root of the user's project. Should always be specified to provide appropriate context.
  string project_root = 2 [
    json_name = "project_root",
    (buf.validate.field).string.min_len = 1
  ];
}

message ListPackagesResponse {
  message PackagePreview {
    // The name of the package.
    string name = 1;

    // The registry that this package belongs to.
    string registry = 2;

    // A short description of the package.
    string description = 3;

    // Either the http(s) URL or the local file path to add/view the package.
    string path = 4;

    // The schema for the data required to add this package.
    string json_schema = 5 [json_name = "json_schema"];
  }

  repeated PackagePreview packages = 1;
}
