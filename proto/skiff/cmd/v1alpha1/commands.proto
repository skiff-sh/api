syntax = "proto3";

package skiff.cmd.v1alpha1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";
import "skiff/registry/v1alpha1/registry.proto";

option go_package = "github.com/skiff-sh/api/go/skiff/cmd/v1alpha1";

// Generates all files within the package and returns the diffs that would result from them being written. Packages hold both templates and WASM plugins that are
// executed locally to edit local files.
message AddPackageRequest {
  // An absolute filepath to the project root. This is used as the root for all plugin file reads and the base reference path for all file outputs.
  string project_root = 1 [
    json_name = "project_root",
    (buf.validate.field).string.min_len = 1
  ];

  // The file path or http(s) URLs to the package. HTTP(s) URLs must start with "http(s)://", otherwise, it's treated as a filepath.
  string package = 2 [(buf.validate.field).string.min_len = 1];

  // The list of permissions available to plugins that are called within the package. If none are specified, no permissions are granted to the user's system.
  repeated skiff.registry.v1alpha1.PackagePermissions.Plugin plugin_permissions = 3 [json_name = "plugin_permissions"];

  // The data needed by the package. Should be a simple map of the field name to the value.
  map<string, google.protobuf.Value> data = 4;
}

// The response data for AddPackageRequest.
message AddPackageResponse {
  // A list of file diffs that should be applied to the user's machine. These use the absolute path using the "project_root" field passed into the request.
  // There is a single unified diff per file.
  repeated string unified_diffs = 1 [json_name = "unified_diffs"];
}

// List all packages within a set of registries. These packages do not include the contents of the files. To get more details about a package use the view package
// call.
message ListPackagesRequest {
  // The URLs or local file paths to registries e.g. ./.skiff/registry.json.
  repeated string registries = 1;
}

message ListPackagesResponse {
  message PackagePreview {
    // The name of the file with the extension.
    string name = 1;

    // The type of the file.
    skiff.registry.v1alpha1.File.Type type = 2;

    // The registry that this package belongs to.
    string registry = 3;

    // A short description of the package.
    optional string description = 4;

    // Either the http(s) URL or the local file path to add/view the package.
    string path = 5;

    // The schema for the data required to add this package.
    string json_schema = 6 [json_name = "json_schema"];
  }

  repeated PackagePreview packages = 1;
}
